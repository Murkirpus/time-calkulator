<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>Калькулятор Pro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Калькулятор Pro">
    <meta name="description" content="Многофункциональный калькулятор с поддержкой времени и скорости">
    <link rel="manifest" id="manifest-placeholder">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%234f46e5'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-weight='bold'%3E123%3C/text%3E%3C/svg%3E">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .calculator {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            padding: 25px;
            width: 100%;
            max-width: 380px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #ffffff;
            font-size: 1.8rem;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .header p {
            color: #a8a8b3;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .mode-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #a8a8b3;
            padding: 10px 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .display {
            background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%);
            border-radius: 15px;
            padding: 25px 20px;
            margin-bottom: 20px;
            text-align: right;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .display-text {
            color: #ffffff;
            font-size: 2.2rem;
            font-weight: 300;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .display-expression {
            color: #a8a8b3;
            font-size: 0.95rem;
            margin-bottom: 10px;
            min-height: 18px;
            opacity: 0.8;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .time-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            height: 65px;
            cursor: pointer;
            transition: all 0.1s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 6px 18px rgba(79, 70, 229, 0.3);
        }

        .btn-time {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            height: 45px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.operator {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            box-shadow: 0 6px 18px rgba(245, 158, 11, 0.3);
        }

        .btn.clear {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 6px 18px rgba(239, 68, 68, 0.3);
        }

        .btn.equals {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 6px 18px rgba(16, 185, 129, 0.3);
        }

        .btn.zero {
            grid-column: span 2;
        }

        .btn.number {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 6px 18px rgba(107, 114, 128, 0.3);
        }

        .hidden {
            display: none !important;
        }

        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 90%;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .install-prompt button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .install-prompt button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .install-prompt .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 4px 8px;
            font-size: 1.2rem;
        }

        @media (max-width: 480px) {
            .calculator {
                padding: 18px;
                margin: 8px;
            }

            .display-text {
                font-size: 1.9rem;
            }

            .btn {
                height: 55px;
                font-size: 1.1rem;
            }

            .btn-time {
                height: 40px;
                font-size: 0.8rem;
            }

            .mode-btn {
                font-size: 0.75rem;
                padding: 8px 3px;
            }

            .install-prompt {
                font-size: 0.9rem;
                padding: 10px 18px;
            }

            .install-prompt button {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="header">
            <h1>Калькулятор Pro</h1>
            <p>Обычный • Время • Скорость</p>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="switchMode('normal')">Обычный</button>
            <button class="mode-btn" onclick="switchMode('time')">Время</button>
            <button class="mode-btn" onclick="switchMode('speed')">Скорость</button>
        </div>

        <div class="display">
            <div class="display-expression" id="expression"></div>
            <div class="display-text" id="result">0</div>
        </div>

        <!-- Time Unit Buttons -->
        <div class="time-buttons hidden" id="timeButtons">
            <button class="btn btn-time" onclick="addTimeUnit('year')">Year</button>
            <button class="btn btn-time" onclick="addTimeUnit('day')">Day</button>
            <button class="btn btn-time" onclick="addTimeUnit('hour')">Hour</button>
            <button class="btn btn-time" onclick="addTimeUnit('min')">Min</button>
            <button class="btn btn-time" onclick="addTimeUnit('sec')">Sec</button>
        </div>

        <!-- Speed Unit Buttons -->
        <div class="time-buttons hidden" id="speedButtons" style="grid-template-columns: repeat(4, 1fr);">
            <button class="btn btn-time" onclick="setSpeedUnit('m/min')">м/мин</button>
            <button class="btn btn-time" onclick="setSpeedUnit('m/h')">м/ч</button>
            <button class="btn btn-time" onclick="setSpeedUnit('km/h')">км/ч</button>
            <button class="btn btn-time" onclick="setSpeedUnit('m/s')">м/с</button>
            <button class="btn btn-time" onclick="setSpeedUnit('km/min')">км/мин</button>
            <button class="btn btn-time" onclick="setSpeedUnit('rpm')">об/мин</button>
            <button class="btn btn-time" onclick="setSpeedUnit('rps')">об/сек</button>
            <button class="btn btn-time" onclick="setSpeedUnit('rph')">об/час</button>
        </div>

        <!-- Normal Calculator Buttons -->
        <div class="buttons" id="normalButtons">
            <button class="btn clear" onclick="clearAll()">AC</button>
            <button class="btn clear" onclick="clearEntry()">C</button>
            <button class="btn operator" onclick="appendOperator('/')">÷</button>
            <button class="btn operator" onclick="appendOperator('*')">×</button>

            <button class="btn number" onclick="appendNumber('7')">7</button>
            <button class="btn number" onclick="appendNumber('8')">8</button>
            <button class="btn number" onclick="appendNumber('9')">9</button>
            <button class="btn operator" onclick="appendOperator('-')">−</button>

            <button class="btn number" onclick="appendNumber('4')">4</button>
            <button class="btn number" onclick="appendNumber('5')">5</button>
            <button class="btn number" onclick="appendNumber('6')">6</button>
            <button class="btn operator" onclick="appendOperator('+')">+</button>

            <button class="btn number" onclick="appendNumber('1')">1</button>
            <button class="btn number" onclick="appendNumber('2')">2</button>
            <button class="btn number" onclick="appendNumber('3')">3</button>
            <button class="btn number" onclick="appendNumber('.')">.</button>

            <button class="btn number zero" onclick="appendNumber('0')">0</button>
            <button class="btn number" onclick="appendNumber('00')">00</button>
            <button class="btn equals" onclick="calculate()">=</button>
        </div>

        <!-- Time Calculator Buttons -->
        <div class="buttons hidden" id="timeCalculatorButtons">
            <button class="btn clear" onclick="clearAll()">AC</button>
            <button class="btn clear" onclick="clearEntry()">C</button>
            <button class="btn operator" onclick="appendOperator('+')">+</button>
            <button class="btn operator" onclick="appendOperator('-')">−</button>

            <button class="btn number" onclick="appendNumber('7')">7</button>
            <button class="btn number" onclick="appendNumber('8')">8</button>
            <button class="btn number" onclick="appendNumber('9')">9</button>
            <button class="btn operator" onclick="showCurrentTime()">Now</button>

            <button class="btn number" onclick="appendNumber('4')">4</button>
            <button class="btn number" onclick="appendNumber('5')">5</button>
            <button class="btn number" onclick="appendNumber('6')">6</button>
            <button class="btn operator" onclick="convertTime()">Full</button>

            <button class="btn number" onclick="appendNumber('1')">1</button>
            <button class="btn number" onclick="appendNumber('2')">2</button>
            <button class="btn number" onclick="appendNumber('3')">3</button>
            <button class="btn number" onclick="appendNumber('.')">.</button>

            <button class="btn number zero" onclick="appendNumber('0')">0</button>
            <button class="btn number" onclick="appendNumber('00')">00</button>
            <button class="btn equals" onclick="calculateTime()">=</button>
        </div>

        <!-- Speed Calculator Buttons -->
        <div class="buttons hidden" id="speedCalculatorButtons">
            <button class="btn clear" onclick="clearAll()">AC</button>
            <button class="btn clear" onclick="clearEntry()">C</button>
            <button class="btn operator" onclick="convertSpeed()">↔</button>
            <button class="btn operator" onclick="showAllSpeeds()">All</button>

            <button class="btn number" onclick="appendNumber('7')">7</button>
            <button class="btn number" onclick="appendNumber('8')">8</button>
            <button class="btn number" onclick="appendNumber('9')">9</button>
            <button class="btn number" onclick="appendNumber('.')">.</button>

            <button class="btn number" onclick="appendNumber('4')">4</button>
            <button class="btn number" onclick="appendNumber('5')">5</button>
            <button class="btn number" onclick="appendNumber('6')">6</button>
            <button class="btn number" onclick="appendNumber('00')">00</button>

            <button class="btn number" onclick="appendNumber('1')">1</button>
            <button class="btn number" onclick="appendNumber('2')">2</button>
            <button class="btn number" onclick="appendNumber('3')">3</button>
            <button class="btn number" onclick="appendNumber('0')">0</button>
        </div>
    </div>

    <!-- PWA Install Prompt -->
    <div id="installPrompt" class="install-prompt hidden">
        <span>📱 Установить приложение?</span>
        <button id="installBtn">Установить</button>
        <button class="close-btn" id="closeInstall">✕</button>
    </div>

    <script>
        // PWA Installation
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const closeInstall = document.getElementById('closeInstall');

        // Create and inject manifest
        const manifestData = {
            name: "Калькулятор Pro",
            short_name: "Калькулятор",
            description: "Многофункциональный калькулятор с поддержкой времени и скорости",
            start_url: "./",
            display: "standalone",
            background_color: "#1a1a2e",
            theme_color: "#1a1a2e",
            orientation: "portrait",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%234f46e5'/%3E%3Ctext x='96' y='130' font-size='90' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-weight='bold'%3E123%3C/text%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                },
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='110' fill='%234f46e5'/%3E%3Ctext x='256' y='350' font-size='240' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-weight='bold'%3E123%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'calculator-v1';
                    const urlsToCache = ['./', './index.html'];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });

                    self.addEventListener('activate', (event) => {
                        event.waitUntil(
                            caches.keys().then((cacheNames) => {
                                return Promise.all(
                                    cacheNames.map((cacheName) => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });
                `;

                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swURL)
                    .then(reg => console.log('Service Worker зарегистрирован'))
                    .catch(err => console.log('Ошибка Service Worker:', err));
            });
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.remove('hidden');
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Результат установки: ${outcome}`);
            deferredPrompt = null;
            installPrompt.classList.add('hidden');
        });

        closeInstall.addEventListener('click', () => {
            installPrompt.classList.add('hidden');
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA установлено');
            installPrompt.classList.add('hidden');
        });

        // Calculator Variables
        let currentMode = 'normal';
        let currentInput = '';
        let operator = '';
        let previousInput = '';
        let shouldResetDisplay = false;
        let currentTimeUnit = '';
        let timeExpression = [];
        let currentSpeedUnit = '';
        let speedValue = '';

        const resultDisplay = document.getElementById('result');
        const expressionDisplay = document.getElementById('expression');
        const normalButtons = document.getElementById('normalButtons');
        const timeButtons = document.getElementById('timeButtons');
        const timeCalculatorButtons = document.getElementById('timeCalculatorButtons');
        const speedButtons = document.getElementById('speedButtons');
        const speedCalculatorButtons = document.getElementById('speedCalculatorButtons');

        const TIME_UNITS = {
            sec: 1,
            min: 60,
            hour: 3600,
            day: 86400,
            year: 31536000
        };

        const TIME_LABELS = {
            sec: 'сек',
            min: 'мин',
            hour: 'ч',
            day: 'дн',
            year: 'лет'
        };

        const SPEED_UNITS = {
            'linear': {
                'm/min': 1,
                'm/h': 1/60,
                'km/h': 1000/60,
                'm/s': 60,
                'km/min': 1000
            },
            'angular': {
                'rpm': 1,
                'rps': 60,
                'rph': 1/60
            }
        };

        const SPEED_LABELS = {
            'm/min': 'м/мин',
            'm/h': 'м/ч',
            'km/h': 'км/ч',
            'm/s': 'м/с',
            'km/min': 'км/мин',
            'rpm': 'об/мин',
            'rps': 'об/сек',
            'rph': 'об/час'
        };

        function switchMode(mode) {
            currentMode = mode;
            const modeButtons = document.querySelectorAll('.mode-btn');
            
            modeButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            normalButtons.classList.add('hidden');
            timeButtons.classList.add('hidden');
            timeCalculatorButtons.classList.add('hidden');
            speedButtons.classList.add('hidden');
            speedCalculatorButtons.classList.add('hidden');

            if (mode === 'normal') {
                normalButtons.classList.remove('hidden');
            } else if (mode === 'time') {
                timeButtons.classList.remove('hidden');
                timeCalculatorButtons.classList.remove('hidden');
            } else if (mode === 'speed') {
                speedButtons.classList.remove('hidden');
                speedCalculatorButtons.classList.remove('hidden');
            }

            clearAll();
        }

        function formatNumber(num) {
            const str = num.toString();
            const parts = str.split('.');
            const intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            return parts.length > 1 ? `${intPart}.${parts[1]}` : intPart;
        }

        function adjustFontSize() {
            const text = resultDisplay.textContent;
            const length = text.length;
            
            if (length <= 10) {
                resultDisplay.style.fontSize = '2.2rem';
            } else if (length <= 15) {
                resultDisplay.style.fontSize = '1.8rem';
            } else if (length <= 20) {
                resultDisplay.style.fontSize = '1.5rem';
            } else if (length <= 25) {
                resultDisplay.style.fontSize = '1.3rem';
            } else {
                resultDisplay.style.fontSize = '1.1rem';
            }
        }

        function updateDisplay() {
            if (currentMode === 'normal') {
                resultDisplay.textContent = formatNumber(currentInput || '0');
                let expression = '';
                if (previousInput && operator) {
                    expression = `${formatNumber(previousInput)} ${getOperatorSymbol(operator)}`;
                    if (currentInput && !shouldResetDisplay) {
                        expression += ` ${formatNumber(currentInput)}`;
                    }
                }
                expressionDisplay.textContent = expression;
                adjustFontSize();
            } else if (currentMode === 'speed') {
                updateSpeedDisplay();
            } else {
                updateTimeDisplay();
            }
        }

        function getOperatorSymbol(op) {
            const symbols = { '+': '+', '-': '−', '*': '×', '/': '÷' };
            return symbols[op] || op;
        }

        function appendNumber(number) {
            if (shouldResetDisplay) {
                currentInput = '';
                shouldResetDisplay = false;
            }
            if (number === '.' && currentInput.includes('.')) return;
            if (currentInput === '0' && number !== '.') {
                currentInput = number;
            } else {
                currentInput += number;
            }
            updateDisplay();
        }

        function appendOperator(op) {
            if (currentMode === 'time') {
                if (currentInput === '' && timeExpression.length === 0) return;
                if (currentInput !== '') {
                    if (currentTimeUnit === '') {
                        alert('Выберите единицу времени!');
                        return;
                    }
                    timeExpression.push({ value: parseFloat(currentInput), unit: currentTimeUnit });
                    currentInput = '';
                    currentTimeUnit = '';
                }
                timeExpression.push({ operator: op });
                updateDisplay();
                return;
            }

            if (currentInput === '' && previousInput === '') return;
            if (previousInput !== '' && currentInput !== '' && !shouldResetDisplay) {
                calculate();
            }
            operator = op;
            previousInput = currentInput || previousInput;
            shouldResetDisplay = true;
            updateDisplay();
        }

        function clearAll() {
            currentInput = '';
            previousInput = '';
            operator = '';
            shouldResetDisplay = false;
            currentTimeUnit = '';
            timeExpression = [];
            currentSpeedUnit = '';
            speedValue = '';
            resultDisplay.style.fontSize = '2.2rem';
            resultDisplay.style.lineHeight = '';
            resultDisplay.style.textAlign = '';
            updateDisplay();
        }

        function clearEntry() {
            currentInput = '';
            if (currentMode === 'time') {
                currentTimeUnit = '';
            } else if (currentMode === 'speed') {
                currentSpeedUnit = '';
                speedValue = '';
            }
            resultDisplay.style.fontSize = '2.2rem';
            resultDisplay.style.lineHeight = '';
            resultDisplay.style.textAlign = '';
            updateDisplay();
        }

        function calculate() {
            if (previousInput === '' || currentInput === '' || operator === '') return;
            const prev = parseFloat(previousInput);
            const current = parseFloat(currentInput);
            let result;

            switch (operator) {
                case '+': result = prev + current; break;
                case '-': result = prev - current; break;
                case '*': result = prev * current; break;
                case '/':
                    if (current === 0) {
                        alert('Деление на ноль невозможно!');
                        return;
                    }
                    result = prev / current;
                    break;
                default: return;
            }

            currentInput = result % 1 === 0 ? result.toString() : parseFloat(result.toFixed(10)).toString();
            operator = '';
            previousInput = '';
            shouldResetDisplay = true;
            updateDisplay();
        }

        // Time functions
        function addTimeUnit(unit) {
            if (currentInput === '') {
                alert('Введите число сначала!');
                return;
            }
            currentTimeUnit = unit;
            updateDisplay();
        }

        function updateTimeDisplay() {
            let expression = '';
            timeExpression.forEach(item => {
                if (item.operator) {
                    expression += ` ${getOperatorSymbol(item.operator)} `;
                } else {
                    expression += item.isCurrentTime ? 'Сейчас' : `${item.value} ${TIME_LABELS[item.unit]}`;
                }
            });

            if (currentInput !== '') {
                if (expression !== '') expression += ' ';
                expression += `${currentInput}`;
                if (currentTimeUnit !== '') expression += ` ${TIME_LABELS[currentTimeUnit]}`;
            }

            expressionDisplay.textContent = expression;

            if (timeExpression.length > 0) {
                resultDisplay.textContent = formatTimeResult(calculateTimeExpression());
            } else if (currentInput !== '') {
                resultDisplay.textContent = `${currentInput}${currentTimeUnit ? ' ' + TIME_LABELS[currentTimeUnit] : ''}`;
            } else {
                resultDisplay.textContent = '0';
            }
            adjustFontSize();
        }

        function calculateTimeExpression() {
            let totalSeconds = 0;
            let currentOperation = '+';
            timeExpression.forEach(item => {
                if (item.operator) {
                    currentOperation = item.operator;
                } else {
                    const seconds = item.isCurrentTime ? Math.floor(item.value) : Math.floor(item.value * TIME_UNITS[item.unit]);
                    totalSeconds += currentOperation === '+' ? seconds : -seconds;
                }
            });
            return Math.floor(totalSeconds);
        }

        function formatTimeResult(totalSeconds) {
            if (totalSeconds === 0) return '0 сек';
            const hasCurrentTime = timeExpression.some(item => item.isCurrentTime);
            
            if (hasCurrentTime) {
                const isNegative = totalSeconds < 0;
                let absSeconds = Math.abs(totalSeconds);
                const days = Math.floor(absSeconds / 86400);
                const remainingSeconds = absSeconds % 86400;
                const hours = Math.floor(remainingSeconds / 3600);
                const minutes = Math.floor((remainingSeconds % 3600) / 60);
                const seconds = remainingSeconds % 60;
                
                if (days === 0 && !isNegative) {
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    let result = [];
                    if (days > 0) result.push(`${days} дн`);
                    if (hours > 0) result.push(`${hours} ч`);
                    if (minutes > 0) result.push(`${minutes} мин`);
                    if (seconds > 0 || result.length === 0) result.push(`${seconds} сек`);
                    return (isNegative ? '−' : '') + result.join(' ');
                }
            }
            
            const isNegative = totalSeconds < 0;
            totalSeconds = Math.abs(totalSeconds);
            const years = Math.floor(totalSeconds / TIME_UNITS.year);
            const days = Math.floor((totalSeconds % TIME_UNITS.year) / TIME_UNITS.day);
            const hours = Math.floor((totalSeconds % TIME_UNITS.day) / TIME_UNITS.hour);
            const minutes = Math.floor((totalSeconds % TIME_UNITS.hour) / TIME_UNITS.min);
            const seconds = Math.floor(totalSeconds % TIME_UNITS.min);

            let result = [];
            if (years > 0) result.push(`${years} ${TIME_LABELS.year}`);
            if (days > 0) result.push(`${days} ${TIME_LABELS.day}`);
            if (hours > 0) result.push(`${hours} ${TIME_LABELS.hour}`);
            if (minutes > 0) result.push(`${minutes} ${TIME_LABELS.min}`);
            if (seconds > 0 || result.length === 0) result.push(`${seconds} ${TIME_LABELS.sec}`);

            return (isNegative ? '−' : '') + result.slice(0, 4).join(' ');
        }

        function showCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;
            
            timeExpression = [{ value: totalSeconds, unit: 'sec', isCurrentTime: true }];
            
            const currentTimeText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            resultDisplay.textContent = currentTimeText;
            expressionDisplay.textContent = 'Сейчас:';
            currentInput = '';
            currentTimeUnit = '';
        }

        function calculateTime() {
            if (currentInput !== '' && currentTimeUnit !== '') {
                timeExpression.push({ value: parseFloat(currentInput), unit: currentTimeUnit });
                currentInput = '';
                currentTimeUnit = '';
            }
            if (timeExpression.length === 0) return;

            const result = calculateTimeExpression();
            timeExpression = [];
            resultDisplay.textContent = formatTimeResult(result);
            expressionDisplay.textContent = '';
            currentInput = '';
            currentTimeUnit = '';
        }

        function convertTime() {
            let totalSeconds;
            if (timeExpression.length > 0) {
                totalSeconds = calculateTimeExpression();
            } else if (currentInput !== '' && currentTimeUnit !== '') {
                totalSeconds = parseFloat(currentInput) * TIME_UNITS[currentTimeUnit];
            } else {
                alert('Введите время для конвертации!');
                return;
            }

            const fullBreakdown = getFullTimeBreakdown(totalSeconds);
            resultDisplay.textContent = fullBreakdown;
            expressionDisplay.textContent = 'Полное разложение времени:';
            currentInput = '';
            currentTimeUnit = '';
            timeExpression = [];
        }

        function getFullTimeBreakdown(totalSeconds) {
            if (totalSeconds === 0) return '0 лет 0 дн 0 ч 0 мин 0 сек';
            const isNegative = totalSeconds < 0;
            totalSeconds = Math.abs(totalSeconds);

            const years = Math.floor(totalSeconds / TIME_UNITS.year);
            const remainingAfterYears = totalSeconds % TIME_UNITS.year;
            const days = Math.floor(remainingAfterYears / TIME_UNITS.day);
            const remainingAfterDays = remainingAfterYears % TIME_UNITS.day;
            const hours = Math.floor(remainingAfterDays / TIME_UNITS.hour);
            const remainingAfterHours = remainingAfterDays % TIME_UNITS.hour;
            const minutes = Math.floor(remainingAfterHours / TIME_UNITS.min);
            const seconds = Math.floor(remainingAfterHours % TIME_UNITS.min);

            const result = `${years} лет ${days} дн ${hours} ч ${minutes} мин ${seconds} сек`;
            return isNegative ? `−${result}` : result;
        }

        // Speed functions
        function setSpeedUnit(unit) {
            if (currentInput === '') {
                alert('Введите число сначала!');
                return;
            }
            currentSpeedUnit = unit;
            speedValue = currentInput;
            convertSpeed();
        }

        function updateSpeedDisplay() {
            if (currentInput !== '' && currentSpeedUnit === '') {
                expressionDisplay.textContent = 'Выберите единицу скорости:';
                resultDisplay.textContent = currentInput;
            } else if (currentInput !== '' && currentSpeedUnit !== '') {
                expressionDisplay.textContent = `${currentInput} ${SPEED_LABELS[currentSpeedUnit]} =`;
                resultDisplay.textContent = '...';
            } else {
                expressionDisplay.textContent = 'Введите скорость';
                resultDisplay.textContent = '0';
            }
            adjustFontSize();
        }

        function convertSpeed() {
            if (speedValue === '' || currentSpeedUnit === '') return;

            const value = parseFloat(speedValue);
            if (isNaN(value)) {
                alert('Введите корректное число!');
                return;
            }

            const isLinear = currentSpeedUnit in SPEED_UNITS.linear;
            const unitGroup = isLinear ? SPEED_UNITS.linear : SPEED_UNITS.angular;

            const baseValue = value * unitGroup[currentSpeedUnit];
            const results = [];
            
            for (const [unit, conversion] of Object.entries(unitGroup)) {
                if (unit !== currentSpeedUnit) {
                    const converted = baseValue / conversion;
                    const formatted = converted % 1 === 0 ? converted.toFixed(0) : converted.toFixed(2);
                    results.push(`${formatted} ${SPEED_LABELS[unit]}`);
                }
            }

            expressionDisplay.textContent = `${speedValue} ${SPEED_LABELS[currentSpeedUnit]} =`;
            resultDisplay.innerHTML = results.join('<br>');
            resultDisplay.style.fontSize = '1.3rem';
            resultDisplay.style.lineHeight = '1.6';
            resultDisplay.style.textAlign = 'left';
        }

        function showAllSpeeds() {
            if (currentInput === '') {
                alert('Введите скорость!');
                return;
            }
            if (currentSpeedUnit === '') {
                alert('Выберите единицу скорости!');
                return;
            }

            speedValue = currentInput;
            const value = parseFloat(speedValue);
            
            if (isNaN(value)) {
                alert('Введите корректное число!');
                return;
            }

            const isLinear = currentSpeedUnit in SPEED_UNITS.linear;
            const unitGroup = isLinear ? SPEED_UNITS.linear : SPEED_UNITS.angular;

            const baseValue = value * unitGroup[currentSpeedUnit];
            const results = [];
            
            for (const [unit, conversion] of Object.entries(unitGroup)) {
                const converted = baseValue / conversion;
                const formatted = converted % 1 === 0 ? converted.toFixed(0) : converted.toFixed(2);
                results.push(`${formatted} ${SPEED_LABELS[unit]}`);
            }

            expressionDisplay.textContent = 'Все единицы:';
            resultDisplay.innerHTML = results.join('<br>');
            resultDisplay.style.fontSize = '1.1rem';
            resultDisplay.style.lineHeight = '1.8';
            resultDisplay.style.textAlign = 'left';
        }

        // Keyboard support
        document.addEventListener('keydown', (event) => {
            const key = event.key;
            if ('0123456789.'.includes(key)) {
                appendNumber(key);
            } else if (key === '+' || key === '-') {
                appendOperator(key);
            } else if ((key === '*' || key === '/') && currentMode === 'normal') {
                appendOperator(key);
            } else if (key === 'Enter' || key === '=') {
                if (currentMode === 'time') calculateTime();
                else calculate();
            } else if (key === 'Escape') {
                clearAll();
            } else if (key === 'Backspace') {
                clearEntry();
            }
        });

        // Touch feedback
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('touchstart', () => {
                if (navigator.vibrate) navigator.vibrate(75);
            }, { passive: true });
        });

        updateDisplay();
    </script>
</body>
</html>
